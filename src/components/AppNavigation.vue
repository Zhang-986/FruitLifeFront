<template>
    <div class="app-navigation">
        <!-- Áªü‰∏ÄÁöÑÂØºËà™Ê†è -->
        <v-app-bar color="primary" density="comfortable" elevation="4" class="app-navigation-bar" fixed>
            <!-- Ê±âÂ†°ËèúÂçïÊåâÈíÆ -->
            <v-app-bar-nav-icon @click="drawer = !drawer" color="white"></v-app-bar-nav-icon>

            <!-- LogoÂíåÊ†áÈ¢ò -->
            <v-toolbar-title class="font-weight-bold text-white">
                <router-link to="/" class="text-decoration-none text-white">
                    üçé Ê∞¥ÊûúÁîüÊ¥ª
                </router-link>
            </v-toolbar-title>

            <v-spacer></v-spacer>

            <!-- Âè≥‰æßÂäüËÉΩÊåâÈíÆ -->
            <div class="d-flex align-center">
                <!-- ÊêúÁ¥¢ÊåâÈíÆ -->
                <v-btn icon color="white" @click="toggleSearch" v-if="showSearchButton">
                    <v-icon>mdi-magnify</v-icon>
                </v-btn>

                <!-- Ë¥≠Áâ©ËΩ¶ÊåâÈíÆ -->
                <v-btn icon color="white" class="ml-2" @click="goToCart" v-if="showCartButton">
                    <v-badge color="error" :content="cartItemCount" :model-value="cartItemCount > 0">
                        <v-icon>mdi-cart</v-icon>
                    </v-badge>
                </v-btn>

                <!-- Áî®Êà∑Â§¥ÂÉèËèúÂçï - ‰ΩøÁî®Êñ∞ÁöÑÂ§¥ÂÉèÁªÑ‰ª∂ -->
                <v-menu v-model="userMenu" :close-on-content-click="false" location="bottom end" offset="8">
                    <template v-slot:activator="{ props }">
                        <v-btn icon color="transparent" class="ml-2 user-avatar-btn" v-bind="props"
                            :class="{ 'avatar-active': userMenu }">
                            <UserAvatar v-if="isLoggedIn" :user="getUserAvatarInfo()" :size="32" clickable />
                            <v-avatar v-else size="32" color="grey-lighten-2">
                                <v-icon size="20" color="grey-darken-2">
                                    mdi-account-circle-outline
                                </v-icon>
                            </v-avatar>
                        </v-btn>
                    </template>

                    <!-- Áî®Êà∑ËèúÂçïÂÜÖÂÆπ -->
                    <v-card class="user-menu-card" min-width="280" elevation="8" rounded="xl">
                        <!-- Â∑≤ÁôªÂΩïÁî®Êà∑ÁöÑËèúÂçï -->
                        <div v-if="isLoggedIn">
                            <!-- Áî®Êà∑‰ø°ÊÅØÂ§¥ÈÉ® -->
                            <v-card-title class="user-menu-header pa-4">
                                <div class="d-flex align-center">
                                    <UserAvatar :user="getUserAvatarInfo()" :size="48" class="me-3" />
                                    <div class="flex-grow-1">
                                        <!-- ÊòæÁ§∫Áî®Êà∑ÊòµÁß∞ÊàñÂ§ÑÁêÜÂêéÁöÑÊòæÁ§∫Âêç -->
                                        <div class="text-h6 font-weight-bold">{{ displayName }}</div>
                                        <!-- ÊòæÁ§∫ÈÇÆÁÆ±Ôºå‰ºòÂÖà‰ΩøÁî®‰∏™‰∫∫ËµÑÊñô‰∏≠ÁöÑÈÇÆÁÆ± -->
                                        <div class="text-caption text-medium-emphasis">
                                            {{ getUserEmail() }}
                                        </div>
                                        <!-- ÂÆåÂñÑÁä∂ÊÄÅÊåáÁ§∫ -->
                                        <v-chip size="x-small" :color="userCompletionStatus.color" variant="flat"
                                            class="mt-1">
                                            <v-icon start size="12">{{ userCompletionStatus.icon }}</v-icon>
                                            {{ userCompletionStatus.text }}
                                        </v-chip>
                                    </div>
                                </div>
                            </v-card-title>

                            <v-divider></v-divider>

                            <!-- ËèúÂçïÈ°π -->
                            <v-list density="compact" class="pa-2">
                                <!-- ‰∏ªË¶ÅÂäüËÉΩ -->
                                <v-list-item v-for="item in loggedInMenuItems" :key="item.title"
                                    :prepend-icon="item.icon" :title="item.title" :subtitle="item.subtitle"
                                    @click="handleMenuClick(item)" class="menu-item" rounded="lg">
                                    <template v-slot:append v-if="item.badge">
                                        <v-chip size="x-small" :color="item.badge.color" variant="flat">
                                            {{ item.badge.text }}
                                        </v-chip>
                                    </template>
                                </v-list-item>

                                <v-divider class="my-2"></v-divider>

                                <!-- ËÆæÁΩÆÂíåÈÄÄÂá∫ -->
                                <v-list-item prepend-icon="mdi-cog" title="ËÆæÁΩÆ" subtitle="‰∏™‰∫∫ÂÅèÂ•ΩËÆæÁΩÆ"
                                    @click="handleMenuClick({ action: 'settings' })" class="menu-item"
                                    rounded="lg"></v-list-item>

                                <v-list-item prepend-icon="mdi-logout" title="ÈÄÄÂá∫ÁôªÂΩï" subtitle="ÂÆâÂÖ®ÈÄÄÂá∫Ë¥¶Êà∑"
                                    @click="handleLogout" class="menu-item text-error" rounded="lg"></v-list-item>
                            </v-list>
                        </div>

                        <!-- Êú™ÁôªÂΩïÁî®Êà∑ÁöÑËèúÂçï -->
                        <div v-else>
                            <v-card-title class="guest-menu-header pa-4 text-center">
                                <div>
                                    <UserAvatar :size="64" class="mb-3" />
                                    <div class="text-h6 font-weight-bold mb-1">Ê¨¢ËøéÊù•Âà∞Ê∞¥ÊûúÁîüÊ¥ª</div>
                                    <div class="text-caption text-medium-emphasis">
                                        ÁôªÂΩïÂêé‰∫´ÂèóÊõ¥Â§öÂäüËÉΩ
                                    </div>
                                </div>
                            </v-card-title>

                            <v-divider></v-divider>

                            <v-card-text class="pa-4">
                                <!-- ÁôªÂΩïÊ≥®ÂÜåÊåâÈíÆ -->
                                <div class="d-flex gap-2 mb-3">
                                    <v-btn color="primary" variant="flat" block @click="navigateToLogin"
                                        class="font-weight-bold">
                                        <v-icon start>mdi-login</v-icon>
                                        ÁôªÂΩï
                                    </v-btn>
                                    <v-btn color="primary" variant="outlined" block @click="navigateToRegister">
                                        <v-icon start>mdi-account-plus</v-icon>
                                        Ê≥®ÂÜå
                                    </v-btn>
                                </div>

                                <!-- Ê∏∏ÂÆ¢ÂäüËÉΩ -->
                                <v-list density="compact">
                                    <v-list-subheader class="text-caption">Ê∏∏ÂÆ¢ÂäüËÉΩ</v-list-subheader>
                                    <v-list-item v-for="item in guestMenuItems" :key="item.title"
                                        :prepend-icon="item.icon" :title="item.title" @click="handleMenuClick(item)"
                                        class="menu-item" rounded="lg"></v-list-item>
                                </v-list>
                            </v-card-text>
                        </div>
                    </v-card>
                </v-menu>
            </div>
        </v-app-bar>

        <!-- ‰æßËæπÂØºËà™ÊäΩÂ±â -->
        <v-navigation-drawer v-model="drawer" temporary class="app-drawer" width="320">
            <!-- Áî®Êà∑‰ø°ÊÅØÂ§¥ÈÉ® -->
            <div class="drawer-header">
                <v-card color="primary" class="pa-4" flat>
                    <div class="d-flex align-center" v-if="isLoggedIn">
                        <UserAvatar :user="getUserAvatarInfo()" :size="60" class="mr-4" />
                        <div>
                            <h3 class="text-white font-weight-bold">{{ displayName }}</h3>
                            <p class="text-white text-body-2 mb-0">Ê¨¢ËøéÂõûÊù•ÔºÅ</p>
                        </div>
                    </div>
                    <div class="text-center" v-else>
                        <UserAvatar :size="60" class="mb-3" />
                        <div>
                            <v-btn color="white" variant="outlined" size="small" @click="navigateToLogin" class="mr-2">
                                ÁôªÂΩï
                            </v-btn>
                            <v-btn color="white" variant="text" size="small" @click="navigateToRegister">
                                Ê≥®ÂÜå
                            </v-btn>
                        </div>
                    </div>
                </v-card>
            </div>

            <!-- ÂØºËà™ËèúÂçï -->
            <v-list nav class="pa-0">
                <!-- ‰∏ªË¶ÅÂäüËÉΩ -->
                <v-list-group value="main" :model-value="activeGroup">
                    <template v-slot:activator="{ props }">
                        <v-list-item v-bind="props" prepend-icon="mdi-home">
                            <v-list-item-title>‰∏ªË¶ÅÂäüËÉΩ</v-list-item-title>
                        </v-list-item>
                    </template>

                    <v-list-item v-for="item in mainMenuItems" :key="item.title" :to="item.to"
                        :active="route.path === item.to" @click="closeDrawer" :prepend-icon="item.icon"
                        class="menu-sub-item">
                        <v-list-item-title>{{ item.title }}</v-list-item-title>
                    </v-list-item>
                </v-list-group>

                <!-- Áî®Êà∑ÂäüËÉΩÔºà‰ªÖÁôªÂΩïÂêéÊòæÁ§∫Ôºâ -->
                <v-list-group value="user" v-if="isLoggedIn" :model-value="activeGroup">
                    <template v-slot:activator="{ props }">
                        <v-list-item v-bind="props" prepend-icon="mdi-account">
                            <v-list-item-title>ÊàëÁöÑË¥¶Êà∑</v-list-item-title>
                        </v-list-item>
                    </template>

                    <v-list-item v-for="item in userMenuItems" :key="item.title" :to="item.to"
                        :active="route.path === item.to" @click="closeDrawer" :prepend-icon="item.icon"
                        class="menu-sub-item">
                        <v-list-item-title>{{ item.title }}</v-list-item-title>
                    </v-list-item>
                </v-list-group>

                <!-- ÂïÜÂìÅÂàÜÁ±ª -->
                <v-list-group value="categories">
                    <template v-slot:activator="{ props }">
                        <v-list-item v-bind="props" prepend-icon="mdi-fruit-grapes">
                            <v-list-item-title>ÂïÜÂìÅÂàÜÁ±ª</v-list-item-title>
                        </v-list-item>
                    </template>

                    <v-list-item v-for="category in categories" :key="category.name"
                        @click="handleCategoryClick(category)" :prepend-icon="category.icon" class="menu-sub-item">
                        <v-list-item-title>{{ category.name }}</v-list-item-title>
                    </v-list-item>
                </v-list-group>

                <v-divider class="my-2"></v-divider>

                <!-- ÂÖ∂‰ªñÂäüËÉΩ -->
                <v-list-item v-for="item in otherMenuItems" :key="item.title" :to="item.to"
                    :active="route.path === item.to" @click="closeDrawer" :prepend-icon="item.icon">
                    <v-list-item-title>{{ item.title }}</v-list-item-title>
                </v-list-item>

                <!-- ÈÄÄÂá∫ÁôªÂΩïÔºà‰ªÖÁôªÂΩïÂêéÊòæÁ§∫Ôºâ -->
                <v-list-item v-if="isLoggedIn" @click="handleLogout" prepend-icon="mdi-logout" class="text-error">
                    <v-list-item-title>ÈÄÄÂá∫ÁôªÂΩï</v-list-item-title>
                </v-list-item>
            </v-list>
        </v-navigation-drawer>

        <!-- ÊêúÁ¥¢Ê†è -->
        <v-expand-transition>
            <v-card v-show="showSearch" class="search-card" elevation="8">
                <v-card-text class="pa-4">
                    <v-text-field v-model="searchQuery" placeholder="ÊêúÁ¥¢ÊÇ®ÂñúÊ¨¢ÁöÑÊ∞¥Êûú..." prepend-inner-icon="mdi-magnify"
                        variant="outlined" hide-details clearable @keyup.enter="handleSearch" class="search-input">
                        <template v-slot:append>
                            <v-btn color="primary" variant="flat" @click="handleSearch" :disabled="!searchQuery">
                                ÊêúÁ¥¢
                            </v-btn>
                        </template>
                    </v-text-field>
                </v-card-text>
            </v-card>
        </v-expand-transition>
    </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { useAvatarStore } from '@/stores/avatar'
import { getUserInfo, checkUserInfoCompleted, type UserInfoVo } from '@/api/profile'
import UserAvatar from './UserAvatar.vue'

const router = useRouter()
const route = useRoute()
const authStore = useAuthStore()
const avatarStore = useAvatarStore()

// Props
interface Props {
    showSearchButton?: boolean
    showCartButton?: boolean
}

const props = withDefaults(defineProps<Props>(), {
    showSearchButton: true,
    showCartButton: true
})

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const drawer = ref(false)
const showSearch = ref(false)
const searchQuery = ref('')
const cartItemCount = ref(3) // Ê®°ÊãüË¥≠Áâ©ËΩ¶Êï∞Èáè
const userMenu = ref(false)
const userInfo = ref<UserInfoVo | null>(null)

// ‰∏ªË¶ÅËèúÂçïÈ°π
const mainMenuItems = ref([
    { title: 'È¶ñÈ°µ', icon: 'mdi-home', to: '/' },
    { title: 'ÂïÜÂìÅÂàóË°®', icon: 'mdi-storefront', to: '/products' },
    { title: 'Áâπ‰ª∑‰øÉÈîÄ', icon: 'mdi-tag-heart', to: '/promotions' },
    { title: 'ÂÖ≥‰∫éÊàë‰ª¨', icon: 'mdi-information', to: '/about' }
])

// Áî®Êà∑ËèúÂçïÈ°π
const userMenuItems = ref([
    { title: 'Áî®Êà∑‰∏≠ÂøÉ', icon: 'mdi-view-dashboard', to: '/user' },
    { title: 'ÊàëÁöÑËÆ¢Âçï', icon: 'mdi-package-variant', to: '/user/orders' },
    { title: 'Ë¥≠Áâ©ËΩ¶', icon: 'mdi-cart', to: '/user/cart' },
    { title: 'ÊàëÁöÑÊî∂Ëóè', icon: 'mdi-heart', to: '/user/favorites' },
    { title: '‰∏™‰∫∫ËµÑÊñô', icon: 'mdi-account', to: '/user/profile' }, // Êõ¥Êñ∞ÈìæÊé•
    { title: 'ÂÆåÂñÑËµÑÊñô', icon: 'mdi-account-edit', to: '/user/profile-wizard' }
])

// ÂÖ∂‰ªñËèúÂçïÈ°π
const otherMenuItems = ref([
    { title: 'ÂÆ¢Êúç‰∏≠ÂøÉ', icon: 'mdi-help-circle', to: '/support' },
    { title: 'ÊÑèËßÅÂèçÈ¶à', icon: 'mdi-message-alert', to: '/feedback' },
    { title: 'ËÆæÁΩÆ', icon: 'mdi-cog', to: '/settings' }
])

// ÂïÜÂìÅÂàÜÁ±ª
const categories = ref([
    { name: 'Êñ∞È≤úÊ∞¥Êûú', icon: 'mdi-apple', color: 'red' },
    { name: 'ÁÉ≠Â∏¶Ê∞¥Êûú', icon: 'mdi-fruit-pineapple', color: 'orange' },
    { name: 'ÊµÜÊûúÁ±ª', icon: 'mdi-fruit-grapes', color: 'purple' },
    { name: 'ÊüëÊ©òÁ±ª', icon: 'mdi-fruit-citrus', color: 'orange' },
    { name: 'Ê†∏ÊûúÁ±ª', icon: 'mdi-fruit-cherries', color: 'pink' },
    { name: 'ËøõÂè£Ê∞¥Êûú', icon: 'mdi-airplane', color: 'blue' }
])

// ËÆ°ÁÆóÂ±ûÊÄß
const isLoggedIn = computed(() => authStore.isLoggedIn)
const displayName = computed(() => {
    // ‰ºòÂÖà‰ΩøÁî®‰∏™‰∫∫ËµÑÊñô‰∏≠ÁöÑÊòµÁß∞
    if (userInfo.value?.nickname) {
        return userInfo.value.nickname
    }
    // ÂÖ∂Ê¨°‰ΩøÁî®auth store‰∏≠ÁöÑÊòµÁß∞
    if (authStore.displayName && authStore.displayName !== 'Áî®Êà∑') {
        return authStore.displayName
    }
    // ÊúÄÂêé‰ΩøÁî®ÈÇÆÁÆ±ÂâçÁºÄ
    const authUserInfo = authStore.getUserInfo()
    if (authUserInfo?.email) {
        return authUserInfo.email.split('@')[0]
    }
    return 'Áî®Êà∑'
})

// Ëé∑ÂèñÁî®Êà∑ÈÇÆÁÆ± - ‰ºòÂÖà‰ΩøÁî®‰∏™‰∫∫ËµÑÊñô
const getUserEmail = () => {
    // Â¶ÇÊûúÊúâ‰∏™‰∫∫ËµÑÊñôÔºå‰∏îÂåÖÂê´ÈÇÆÁÆ±Ôºå‰ΩøÁî®‰∏™‰∫∫ËµÑÊñô‰∏≠ÁöÑÈÇÆÁÆ±
    if (userInfo.value?.email) {
        return userInfo.value.email
    }

    // Âê¶Âàô‰ΩøÁî®ËÆ§ËØÅ‰ø°ÊÅØ‰∏≠ÁöÑÈÇÆÁÆ±
    const authInfo = authStore.getUserInfo()
    if (authInfo?.email) {
        return authInfo.email
    }

    return 'Êú™Áü•ÈÇÆÁÆ±'
}

// Ëé∑ÂèñÁî®Êà∑Â§¥ÂÉè‰ø°ÊÅØ - ‰øÆÂ§çÈÄªËæë
const getUserAvatarInfo = () => {
    const email = getUserEmail()
    const nickname = displayName.value

    return {
        // Âè™ÊúâÂΩìÈÇÆÁÆ±‰∏çÊòØ"Êú™Áü•ÈÇÆÁÆ±"Êó∂Êâç‰º†ÈÄí
        email: email !== 'Êú™Áü•ÈÇÆÁÆ±' ? email : undefined,
        // ‰ºòÂÖà‰ΩøÁî®‰∏™‰∫∫ËµÑÊñôÊòµÁß∞ÔºåÈÅøÂÖç‰ΩøÁî®ÈÇÆÁÆ±ÂâçÁºÄ‰Ωú‰∏∫ÊòµÁß∞
        nickname: userInfo.value?.nickname || nickname,
        id: userInfo.value?.id
    }
}

// Áî®Êà∑ÂÆåÂñÑÁä∂ÊÄÅ - Âü∫‰∫éÂÆûÈôÖÂä†ËΩΩÁöÑÁî®Êà∑‰ø°ÊÅØ
const userCompletionStatus = computed(() => {
    if (!isLoggedIn.value) {
        return {
            color: 'grey',
            icon: 'mdi-account-circle-outline',
            text: 'Êú™ÁôªÂΩï'
        }
    }

    if (!userInfo.value) {
        return {
            color: 'info',
            icon: 'mdi-loading',
            text: 'Âä†ËΩΩ‰∏≠...'
        }
    }

    // Ê£ÄÊü•ÊòØÂê¶ÂÆåÂñÑ‰∫Ü‰∏™‰∫∫ËµÑÊñô
    const hasBasicInfo = userInfo.value.nickname &&
        userInfo.value.age &&
        userInfo.value.gender &&
        userInfo.value.heightCm &&
        userInfo.value.weightKg

    if (userInfo.value.isCompleted && hasBasicInfo) {
        return {
            color: 'success',
            icon: 'mdi-check-circle',
            text: 'ËµÑÊñôÂÆåÊï¥'
        }
    } else if (userInfo.value.nickname) {
        return {
            color: 'warning',
            icon: 'mdi-account-edit',
            text: 'ÈÉ®ÂàÜÂÆåÂñÑ'
        }
    } else {
        return {
            color: 'error',
            icon: 'mdi-alert-circle',
            text: 'ÂæÖÂÆåÂñÑ'
        }
    }
})

// Â∑≤ÁôªÂΩïÁî®Êà∑ËèúÂçïÈ°π
const loggedInMenuItems = computed(() => [
    {
        title: 'Áî®Êà∑‰∏≠ÂøÉ',
        subtitle: 'Êü•Áúã‰∏™‰∫∫‰ø°ÊÅØ',
        icon: 'mdi-view-dashboard',
        action: 'dashboard'
    },
    {
        title: '‰∏™‰∫∫ËµÑÊñô',
        subtitle: 'Êü•ÁúãÂíåÁºñËæëËµÑÊñô',
        icon: 'mdi-account',
        action: 'profile'
    },
    {
        title: 'ÊàëÁöÑËÆ¢Âçï',
        subtitle: 'Êü•ÁúãËÆ¢ÂçïÂéÜÂè≤',
        icon: 'mdi-package-variant',
        action: 'orders'
    },
    {
        title: 'Ë¥≠Áâ©ËΩ¶',
        subtitle: `${cartItemCount.value} ‰ª∂ÂïÜÂìÅ`,
        icon: 'mdi-cart',
        action: 'cart',
        badge: cartItemCount.value > 0 ? {
            color: 'error',
            text: cartItemCount.value.toString()
        } : undefined
    },
    {
        title: 'ÊàëÁöÑÊî∂Ëóè',
        subtitle: 'Êî∂ËóèÁöÑÂïÜÂìÅ',
        icon: 'mdi-heart',
        action: 'favorites'
    }
])

// Ê∏∏ÂÆ¢ËèúÂçïÈ°π
const guestMenuItems = ref([
    {
        title: 'ÊµèËßàÂïÜÂìÅ',
        icon: 'mdi-storefront',
        action: 'products'
    },
    {
        title: 'Áâπ‰ª∑‰øÉÈîÄ',
        icon: 'mdi-tag-heart',
        action: 'promotions'
    },
    {
        title: 'ÂÖ≥‰∫éÊàë‰ª¨',
        icon: 'mdi-information',
        action: 'about'
    },
    {
        title: 'ÂÆ¢Êúç‰∏≠ÂøÉ',
        icon: 'mdi-help-circle',
        action: 'support'
    }
])

// ÂΩìÂâçÊøÄÊ¥ªÁöÑËèúÂçïÈ°π
const activeGroup = ref<string[]>([])

// Ê†πÊçÆÂΩìÂâçË∑ØÁî±ËÆæÁΩÆÊøÄÊ¥ªÁöÑËèúÂçïÁªÑ
const setActiveMenuFromRoute = () => {
    const currentPath = route.path

    // Ê∏ÖÁ©∫‰πãÂâçÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
    activeGroup.value = []

    // Ê†πÊçÆË∑ØÂæÑÂà§Êñ≠Â∫îËØ•ÊøÄÊ¥ªÂì™‰∏™ËèúÂçïÁªÑ
    if (currentPath.startsWith('/user')) {
        if (isLoggedIn.value) {
            activeGroup.value = ['user']
        }
    } else if (currentPath === '/' || currentPath === '/products' || currentPath === '/promotions' || currentPath === '/about') {
        activeGroup.value = ['main']
    }
    // ‰∏çËá™Âä®Â±ïÂºÄ‰ªª‰ΩïËèúÂçïÁªÑÔºåËÆ©Áî®Êà∑‰∏ªÂä®ÁÇπÂáª
}

// ÁõëÂê¨Ë∑ØÁî±ÂèòÂåñ
watch(() => route.path, () => {
    setActiveMenuFromRoute()
}, { immediate: true })

// ÊñπÊ≥ï
const closeDrawer = () => {
    drawer.value = false
}

const navigateToLogin = () => {
    closeDrawer()
    userMenu.value = false
    router.push('/login')
}

const navigateToRegister = () => {
    closeDrawer()
    userMenu.value = false
    router.push('/register')
}

const toggleSearch = () => {
    showSearch.value = !showSearch.value
}

const handleSearch = () => {
    if (searchQuery.value.trim()) {
        console.log('ÊêúÁ¥¢:', searchQuery.value)
        showSearch.value = false
        // TODO: ÂÆûÁé∞ÊêúÁ¥¢ÂäüËÉΩ
        router.push(`/search?q=${encodeURIComponent(searchQuery.value)}`)
    }
}

const goToCart = () => {
    if (isLoggedIn.value) {
        router.push('/user/cart')
    } else {
        router.push('/login')
    }
}

const handleCategoryClick = (category: any) => {
    closeDrawer()
    console.log('ÁÇπÂáªÂàÜÁ±ª:', category.name)
    // TODO: ÂÆûÁé∞ÂàÜÁ±ªÁ≠õÈÄâ
    router.push(`/products?category=${encodeURIComponent(category.name)}`)
}

const handleLogout = async () => {
    console.log('üö™ ÂØºËà™Ê†èÈÄÄÂá∫ÁôªÂΩï')

    try {
        // ‰ΩøÁî®auth storeÁöÑÈÄÄÂá∫ÊñπÊ≥ï
        await authStore.logout()

        closeDrawer()
        userMenu.value = false

        // Ë∑≥ËΩ¨Âà∞È¶ñÈ°µ
        await router.push('/')
    } catch (error) {
        console.error('ÂØºËà™Ê†èÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•:', error)

        // Âç≥‰ΩøÂ§±Ë¥•‰πüÂÖ≥Èó≠ÊäΩÂ±âÂπ∂Ë∑≥ËΩ¨
        closeDrawer()
        userMenu.value = false
        await router.push('/')
    }
}

const handleMenuClick = (item: any) => {
    userMenu.value = false
    closeDrawer()

    switch (item.action) {
        case 'dashboard':
            router.push('/user')
            break
        case 'profile':
            router.push('/user/profile') // Êõ¥Êñ∞ÈìæÊé•
            break
        case 'orders':
            router.push('/user/orders')
            break
        case 'cart':
            goToCart()
            break
        case 'favorites':
            router.push('/user/favorites')
            break
        case 'settings':
            router.push('/user/settings')
            break
        case 'products':
            router.push('/products')
            break
        case 'promotions':
            router.push('/promotions')
            break
        case 'about':
            router.push('/about')
            break
        case 'support':
            router.push('/support')
            break
        default:
            console.log('Êú™Áü•ËèúÂçïÈ°π:', item)
    }
}

// Â§ÑÁêÜÁî®Êà∑Â§¥ÂÉèÁÇπÂáªÔºà‰øùÊåÅÂêëÂêéÂÖºÂÆπÔºâ
const handleUserAction = () => {
    // Â¶ÇÊûúËèúÂçïÊú™ÊâìÂºÄÔºåÂàôÊâìÂºÄËèúÂçï
    if (!userMenu.value) {
        userMenu.value = true
    }
}

// Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ - Â¢ûÂº∫ÈîôËØØÂ§ÑÁêÜ
const loadUserInfo = async () => {
    if (!isLoggedIn.value) {
        userInfo.value = null
        return
    }

    try {
        console.log('üîç ÂØºËà™Ê†èÂºÄÂßãÂä†ËΩΩÁî®Êà∑‰ø°ÊÅØ')
        const response = await getUserInfo()

        if (response.code === 200 && response.data) {
            userInfo.value = response.data
            console.log('‚úÖ ÂØºËà™Ê†èÁî®Êà∑‰ø°ÊÅØÂä†ËΩΩÊàêÂäü:', {
                nickname: userInfo.value.nickname,
                email: userInfo.value.email,
                isCompleted: userInfo.value.isCompleted
            })
        } else {
            console.warn('‚ö†Ô∏è ÂØºËà™Ê†èËé∑ÂèñÁî®Êà∑‰ø°ÊÅØËøîÂõûÂºÇÂ∏∏:', response)
            userInfo.value = null
        }
    } catch (error) {
        console.error('‚ùå ÂØºËà™Ê†èÂä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error)
        // ÈùôÈªòÂ§ÑÁêÜÈîôËØØÔºå‰∏çÂΩ±ÂìçÂØºËà™ÂäüËÉΩ
        userInfo.value = null
    }
}

// ÁõëÂê¨ÁôªÂΩïÁä∂ÊÄÅÂèòÂåñ
watch(isLoggedIn, async (newValue, oldValue) => {
    console.log('üîÑ ÂØºËà™Ê†èÁõëÂê¨Âà∞ÁôªÂΩïÁä∂ÊÄÅÂèòÂåñ:', { from: oldValue, to: newValue })

    if (newValue) {
        // ÁôªÂΩïÊó∂ÂàùÂßãÂåñÂ§¥ÂÉèÈÖçÁΩÆÂíåÂä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
        await avatarStore.initializeAvatar()  // Á°Æ‰øùÂ§¥ÂÉèÈÖçÁΩÆË¢´Ê≠£Á°ÆÂä†ËΩΩ
        await loadUserInfo()
    } else {
        // ÁôªÂá∫Êó∂Ê∏ÖÈô§Â§¥ÂÉèÈÖçÁΩÆÂíåÁî®Êà∑‰ø°ÊÅØ
        avatarStore.clearAvatar()
        userInfo.value = null
        console.log('üóëÔ∏è ÂØºËà™Ê†èÂ∑≤Ê∏ÖÈô§Áî®Êà∑‰ø°ÊÅØ')
    }
}, { immediate: true })
</script>

<style scoped>
.app-navigation {
    position: relative;
}

.app-navigation-bar {
    position: fixed !important;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}

.app-drawer {
    z-index: 1100;
}

.drawer-header {
    position: sticky;
    top: 0;
    z-index: 1;
}

.search-card {
    position: fixed;
    top: 64px;
    left: 0;
    right: 0;
    z-index: 999;
    border-radius: 0 0 16px 16px !important;
}

.search-input {
    max-width: 600px;
    margin: 0 auto;
}

/* ÁßªÂä®Á´ØÈÄÇÈÖç */
@media (max-width: 600px) {
    .search-card {
        top: 56px;
    }
}

/* ‰∫åÁ∫ßËèúÂçïÈ°πÊ†∑Âºè */
.menu-sub-item {
    padding-left: 56px !important;
}

/* ÊøÄÊ¥ªÁä∂ÊÄÅÁöÑËèúÂçïÈ°π */
:deep(.v-list-item--active) {
    background-color: rgba(76, 175, 80, 0.1) !important;
    color: #4CAF50 !important;
}

:deep(.v-list-item--active .v-list-item-title) {
    color: #4CAF50 !important;
    font-weight: 600 !important;
}

:deep(.v-list-item--active .v-icon) {
    color: #4CAF50 !important;
}

/* ËèúÂçïÂàÜÁªÑÊ†áÈ¢òÊ†∑Âºè */
:deep(.v-list-group__header) {
    font-weight: 600 !important;
}

/* ÊÇ¨ÂÅúÊïàÊûú */
:deep(.v-list-item:hover) {
    background-color: rgba(76, 175, 80, 0.05) !important;
}

/* Áî®Êà∑Â§¥ÂÉèÊåâÈíÆÊ†∑Âºè */
.user-avatar-btn {
    transition: all 0.3s ease;
}

.user-avatar-btn:hover,
.user-avatar-btn.avatar-active {
    background-color: rgba(255, 255, 255, 0.1) !important;
    transform: scale(1.05);
}

/* Áî®Êà∑ËèúÂçïÂç°Áâá */
.user-menu-card {
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.user-menu-header {
    background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
    color: white;
}

.guest-menu-header {
    background: linear-gradient(135deg, #607D8B 0%, #90A4AE 100%);
    color: white;
}

/* ËèúÂçïÈ°πÊ†∑Âºè */
.menu-item {
    margin-bottom: 4px;
    transition: all 0.2s ease;
}

.menu-item:hover {
    background-color: rgba(76, 175, 80, 0.08) !important;
    transform: translateX(4px);
}

.menu-item.text-error:hover {
    background-color: rgba(244, 67, 54, 0.08) !important;
}

/* ËèúÂçïÈ°πÂõæÊ†áÊ†∑Âºè */
:deep(.v-list-item__prepend > .v-icon) {
    opacity: 0.8;
}

.menu-item:hover :deep(.v-list-item__prepend > .v-icon) {
    opacity: 1;
    color: #4CAF50;
}

.menu-item.text-error:hover :deep(.v-list-item__prepend > .v-icon) {
    color: #f44336;
}

/* ÁßªÂä®Á´ØÈÄÇÈÖç */
@media (max-width: 600px) {
    .user-menu-card {
        min-width: 260px;
    }
}

/* Ê∑±Ëâ≤‰∏ªÈ¢òÊîØÊåÅ */
.v-theme--dark .user-menu-card {
    background: rgba(33, 33, 33, 0.95) !important;
    border-color: rgba(255, 255, 255, 0.12) !important;
}

.v-theme--dark .menu-item:hover {
    background-color: rgba(76, 175, 80, 0.12) !important;
}
</style>
