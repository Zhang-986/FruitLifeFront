<template>
    <div class="home-page">
        <AppNavigation :show-search-button="true" />

        <div class="home-content">
            <!-- Â¶ÇÊûúÁî®Êà∑Â∑≤ÁôªÂΩï -->
            <template v-if="isLoggedIn">
                <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü - Â∑¶Âè≥Â∏ÉÂ±Ä -->
                <section class="main-content-section">
                    <v-container>
                        <v-row>
                            <!-- Â∑¶‰æßÔºö‰ªäÊó•Êé®Ëçê (Âç†‰∏ªË¶ÅÁ©∫Èó¥) -->
                            <v-col cols="12" lg="8">
                                <div class="today-recommendation-wrapper">
                                    <div class="text-center mb-6">
                                        <h2 class="text-h4 font-weight-bold mb-2">
                                            üçé ‰ªäÊó•Êé®Ëçê
                                        </h2>
                                        <p class="text-body-1 text-medium-emphasis">
                                            {{ formatDate(new Date()) }} ÁöÑÂÅ•Â∫∑ÈÄâÊã©
                                        </p>
                                    </div>

                                    <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                                    <div v-if="loading" class="text-center py-12">
                                        <v-progress-circular color="primary" size="64"
                                            indeterminate></v-progress-circular>
                                        <div class="text-h6 mt-4 text-grey">Ê≠£Âú®‰∏∫ÊÇ®Á≤æÈÄâ‰ªäÊó•Ê∞¥Êûú...</div>
                                    </div>

                                    <!-- Êé®ËçêÊ∞¥ÊûúÂ±ïÁ§∫ -->
                                    <div v-else-if="dailyFruit" class="daily-fruit-container">
                                        <v-card class="daily-fruit-card" elevation="12" rounded="xl">
                                            <v-row no-gutters>
                                                <!-- Â∑¶‰æßÔºöÊ∞¥ÊûúÂõæÁâá -->
                                                <v-col cols="12" md="5">
                                                    <div class="fruit-image-section">
                                                        <!-- Áõ¥Êé•‰ΩøÁî®emojiÂ±ïÁ§∫Ôºå‰∏çÂÜçÈúÄË¶ÅÂõæÁâá -->
                                                        <div class="fruit-emoji-display">
                                                            <div class="emoji-container">
                                                                <!-- Â§ßÂè∑Ê∞¥Êûúemoji -->
                                                                <div class="fruit-emoji">{{
                                                                    getFruitEmoji(dailyFruit.name) }}</div>
                                                                <!-- Ê∞¥ÊûúÂêçÁß∞ -->
                                                                <div class="fruit-name-text">{{ dailyFruit.name }}</div>
                                                                <!-- Ë£ÖÈ•∞ÊÄßÂÖÉÁ¥† -->
                                                                <div class="decoration-dots">
                                                                    <span>‚ú®</span>
                                                                    <span>üåø</span>
                                                                    <span>‚ú®</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Êó•ÊúüÊ†áÁ≠æ -->
                                                        <v-chip class="date-badge" color="primary" variant="elevated">
                                                            <v-icon start size="small">mdi-calendar-today</v-icon>
                                                            ‰ªäÊó•Êé®Ëçê
                                                        </v-chip>
                                                    </div>
                                                </v-col>

                                                <!-- Âè≥‰æßÔºöÊ∞¥Êûú‰ø°ÊÅØ -->
                                                <v-col cols="12" md="7">
                                                    <v-card-text class="pa-6 h-100 d-flex flex-column">
                                                        <!-- Ê∞¥ÊûúÊ†áÈ¢ò -->
                                                        <div class="mb-3">
                                                            <h3 class="text-h4 font-weight-bold fruit-name mb-2">
                                                                {{ dailyFruit.name }}
                                                            </h3>
                                                            <p class="text-body-1 text-medium-emphasis">
                                                                {{ dailyFruit.description || '‰ªäÂ§©Â∞±ÈÄâÂÆÉÔºå‰∏∫ÂÅ•Â∫∑Âä†ÂàÜÔºÅ' }}
                                                            </p>
                                                        </div>

                                                        <!-- Âø´ÈÄü‰ø°ÊÅØÂç°Áâá -->
                                                        <div class="info-cards-row mb-3">
                                                            <v-row dense>
                                                                <v-col cols="6" v-if="dailyFruit.flavorProfile">
                                                                    <v-card variant="tonal" color="pink" rounded="lg">
                                                                        <v-card-text class="pa-2 text-center">
                                                                            <v-icon color="pink" size="small"
                                                                                class="mb-1">mdi-emoticon-tongue</v-icon>
                                                                            <div class="text-caption">Âè£Âë≥</div>
                                                                            <div class="text-body-2 font-weight-medium">
                                                                                {{ dailyFruit.flavorProfile }}</div>
                                                                        </v-card-text>
                                                                    </v-card>
                                                                </v-col>
                                                                <v-col cols="6" v-if="dailyFruit.seasonInfo">
                                                                    <v-card variant="tonal" color="orange" rounded="lg">
                                                                        <v-card-text class="pa-2 text-center">
                                                                            <v-icon color="orange" size="small"
                                                                                class="mb-1">mdi-calendar</v-icon>
                                                                            <div class="text-caption">Â≠£ËäÇ</div>
                                                                            <div class="text-body-2 font-weight-medium">
                                                                                {{ dailyFruit.seasonInfo }}</div>
                                                                        </v-card-text>
                                                                    </v-card>
                                                                </v-col>
                                                            </v-row>
                                                        </div>

                                                        <!-- Ëê•ÂÖª‰ª∑ÂÄº -->
                                                        <div v-if="dailyFruit.nutritionSummary" class="mb-3">
                                                            <v-card variant="tonal" color="success" rounded="lg">
                                                                <v-card-text class="pa-2">
                                                                    <div class="d-flex align-center mb-1">
                                                                        <v-icon color="success" size="small"
                                                                            class="mr-2">mdi-nutrition</v-icon>
                                                                        <span
                                                                            class="text-caption font-weight-medium">Ëê•ÂÖª‰ª∑ÂÄº</span>
                                                                    </div>
                                                                    <div class="text-body-2">{{
                                                                        dailyFruit.nutritionSummary }}</div>
                                                                </v-card-text>
                                                            </v-card>
                                                        </div>

                                                        <!-- ÂÅ•Â∫∑ÂäüÊïàÊ†áÁ≠æ - Á¥ßÂáëÊòæÁ§∫ -->
                                                        <div v-if="getLifePropertiesArray(dailyFruit).length"
                                                            class="mb-3 flex-grow-1">
                                                            <div
                                                                class="text-body-2 font-weight-medium mb-1 d-flex align-center">
                                                                <v-icon color="primary" size="small"
                                                                    class="mr-1">mdi-tag-multiple</v-icon>
                                                                ÂÅ•Â∫∑ÂäüÊïà
                                                            </div>
                                                            <div class="d-flex flex-wrap ga-1">
                                                                <v-chip
                                                                    v-for="property in getLifePropertiesArray(dailyFruit).slice(0, 4)"
                                                                    :key="property" color="primary" variant="tonal"
                                                                    size="x-small">
                                                                    {{ property }}
                                                                </v-chip>
                                                                <v-chip
                                                                    v-if="getLifePropertiesArray(dailyFruit).length > 4"
                                                                    color="grey" variant="tonal" size="x-small">
                                                                    +{{ getLifePropertiesArray(dailyFruit).length - 4 }}
                                                                </v-chip>
                                                            </div>
                                                        </div>

                                                        <!-- Êìç‰ΩúÊåâÈíÆ -->
                                                        <div class="d-flex ga-2 mt-auto">
                                                            <v-btn color="primary" variant="flat" rounded="lg"
                                                                @click="exploreFruit" class="flex-grow-1">
                                                                <v-icon start size="small">mdi-magnify</v-icon>
                                                                ‰∫ÜËß£Êõ¥Â§öÊ∞¥Êûú
                                                            </v-btn>
                                                        </div>
                                                    </v-card-text>
                                                </v-col>
                                            </v-row>
                                        </v-card>
                                    </div>

                                    <!-- ÈîôËØØÁä∂ÊÄÅ -->
                                    <div v-else class="text-center py-12">
                                        <v-icon size="64" color="grey-lighten-2">mdi-alert-circle</v-icon>
                                        <div class="text-h6 mt-4 text-grey">‰ªäÊó•Êé®ËçêÊöÇÊó∂Êó†Ê≥ïÂä†ËΩΩ</div>
                                        <v-btn color="primary" variant="outlined" @click="loadDailyFruit" class="mt-4">
                                            <v-icon start>mdi-refresh</v-icon>
                                            ÈáçÊñ∞Âä†ËΩΩ
                                        </v-btn>
                                    </div>
                                </div>
                            </v-col>

                            <!-- Âè≥‰æßÔºöÂäüËÉΩÈù¢Êùø (Á¥ßÂáëÂ∏ÉÂ±Ä) -->
                            <v-col cols="12" lg="4">
                                <div class="function-panel">
                                    <!-- Áî®Êà∑Áä∂ÊÄÅÂç°Áâá -->
                                    <v-card class="user-status-card mb-4" elevation="6" rounded="xl">
                                        <v-card-text class="pa-4">
                                            <div class="text-center mb-3">
                                                <div class="welcome-text">Ê¨¢ËøéÂõûÊù•, {{ username }}! üëã</div>
                                            </div>

                                            <!-- Á¥ßÂáëÁöÑÁä∂ÊÄÅÊòæÁ§∫ -->
                                            <v-row dense>
                                                <v-col cols="4">
                                                    <div class="status-item" @click="goToPointsCenter">
                                                        <div class="status-icon">üí∞</div>
                                                        <div class="status-value">{{ userPoints.toLocaleString() }}
                                                        </div>
                                                        <div class="status-label">ÁßØÂàÜ</div>
                                                    </div>
                                                </v-col>
                                                <v-col cols="4">
                                                    <div class="status-item" @click="goToInventory">
                                                        <div class="status-icon">üß∫</div>
                                                        <div class="status-value">{{ inventoryCount }}</div>
                                                        <div class="status-label">Â∫ìÂ≠ò</div>
                                                    </div>
                                                </v-col>
                                                <v-col cols="4">
                                                    <div class="status-item" @click="handleCheckIn"
                                                        :class="{ 'checked-in': todayCheckedIn }">
                                                        <div class="status-icon">{{ todayCheckedIn ? '‚úÖ' : 'üìÖ' }}</div>
                                                        <div class="status-value">{{ consecutiveDays }}</div>
                                                        <div class="status-label">{{ todayCheckedIn ? 'Â∑≤Á≠æÂà∞' : 'Á≠æÂà∞' }}
                                                        </div>
                                                    </div>
                                                </v-col>
                                            </v-row>
                                        </v-card-text>
                                    </v-card>

                                    <!-- Âø´Êç∑ÂäüËÉΩÁΩëÊ†º -->
                                    <v-card class="quick-functions-card mb-4" elevation="6" rounded="xl">
                                        <v-card-title class="pa-3 pb-1">
                                            <span class="text-h6">üöÄ Âø´Êç∑ÂäüËÉΩ</span>
                                        </v-card-title>
                                        <v-card-text class="pa-3 pt-1">
                                            <v-row dense>
                                                <v-col cols="6" sm="4" v-for="action in quickActions"
                                                    :key="action.title">
                                                    <div class="quick-action-item" @click="action.handler">
                                                        <div class="action-icon">{{ action.icon }}</div>
                                                        <div class="action-title">{{ action.title }}</div>
                                                    </div>
                                                </v-col>
                                            </v-row>
                                        </v-card-text>
                                    </v-card>

                                    <!-- ÂÅ•Â∫∑Â∞èË¥¥Â£´ -->
                                    <v-card class="health-tip-card" elevation="6" rounded="xl">
                                        <v-card-title class="pa-3 pb-1">
                                            <span class="text-h6">üí° ÂÅ•Â∫∑Ë¥¥Â£´</span>
                                        </v-card-title>
                                        <v-card-text class="pa-3 pt-1">
                                            <p class="text-body-2 mb-2">{{ todayHealthTip }}</p>
                                            <v-btn color="primary" variant="text" size="small"
                                                @click="refreshHealthTip">
                                                <v-icon start size="small">mdi-refresh</v-icon>
                                                Êç¢‰∏ÄÊù°
                                            </v-btn>
                                        </v-card-text>
                                    </v-card>
                                </div>
                            </v-col>
                        </v-row>
                    </v-container>
                </section>
            </template>

            <!-- Â¶ÇÊûúÁî®Êà∑Êú™ÁôªÂΩï -->
            <template v-else>
                <section class="guest-welcome-section">
                    <v-container>
                        <div class="text-center py-16">
                            <div class="guest-icon mb-6">üçì</div>
                            <h1 class="text-h2 font-weight-bold mb-4 guest-title">
                                Êé¢Á¥¢ÊØèÊó•Ê∞¥ÊûúÊé®Ëçê
                            </h1>
                            <p class="text-h5 mb-8 text-medium-emphasis">
                                ÁôªÂΩïÂêéÊØèÂ§©‰∏∫ÊÇ®Êé®Ëçê‰∏ÄÊ¨æÂÅ•Â∫∑Ê∞¥Êûú<br />ÂºÄÂêØÊÇ®ÁöÑ‰∏™ÊÄßÂåñÂÅ•Â∫∑‰πãÊóÖ
                            </p>
                            <div class="d-flex justify-center ga-4">
                                <v-btn color="primary" size="x-large" rounded="xl" elevation="4" @click="login">
                                    <v-icon start>mdi-login-variant</v-icon>
                                    Á´ãÂç≥ÁôªÂΩï
                                </v-btn>
                                <v-btn color="secondary" variant="outlined" size="x-large" rounded="xl"
                                    @click="register">
                                    <v-icon start>mdi-account-plus-outline</v-icon>
                                    ÂÖçË¥πÊ≥®ÂÜå
                                </v-btn>
                            </div>
                        </div>
                    </v-container>
                </section>
            </template>
        </div>

        <!-- ÊèêÁ§∫‰ø°ÊÅØ -->
        <v-snackbar v-model="snackbar" :color="snackbarColor" timeout="3000" location="top">
            {{ snackbarText }}
            <template v-slot:actions>
                <v-btn color="white" variant="text" @click="snackbar = false">ÂÖ≥Èó≠</v-btn>
            </template>
        </v-snackbar>
    </div>
</template>

<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import { useRouter } from 'vue-router'
import AppNavigation from '@/components/AppNavigation.vue'
import { useAuthStore } from '@/stores/auth'
import { getFruitByName, type Fruit } from '@/api/fruit'
import { getTodayFruitName, getTodayDateString, isNewDay } from '@/utils/daily-fruit'

const authStore = useAuthStore()
const router = useRouter()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const loading = ref(false)
const dailyFruit = ref<Fruit | null>(null)
const snackbar = ref(false)
const snackbarText = ref('')
const snackbarColor = ref('success')

// Êñ∞Â¢ûÂìçÂ∫îÂºèÊï∞ÊçÆ
const userPoints = ref(1250) // Ê®°ÊãüÁî®Êà∑ÁßØÂàÜ
const inventoryCount = ref(12) // Ê®°ÊãüÂ∫ìÂ≠òÊï∞Èáè
const consecutiveDays = ref(7) // Ê®°ÊãüËøûÁª≠Á≠æÂà∞Â§©Êï∞
const todayCheckedIn = ref(false) // ‰ªäÊó•ÊòØÂê¶Â∑≤Á≠æÂà∞
const todayHealthTip = ref('ÊØèÂ§©È£üÁî®2-3Áßç‰∏çÂêåÈ¢úËâ≤ÁöÑÊ∞¥ÊûúÔºåËÉΩÂ§üËé∑ÂæóÊõ¥ÂÖ®Èù¢ÁöÑËê•ÂÖªÁ¥†„ÄÇ') // ÂÅ•Â∫∑Â∞èË¥¥Â£´

// ËÆ°ÁÆóÂ±ûÊÄß
const isLoggedIn = computed(() => authStore.isLoggedIn)
const username = computed(() => authStore.displayName)

// Áî®Êà∑Á≠âÁ∫ß‰ø°ÊÅØ
const userLevel = ref({
    level: 2,
    name: 'ÂÅ•Â∫∑Ëææ‰∫∫',
    minPoints: 500,
    maxPoints: 2000,
    benefits: ['ÊØèÊó•‰ªªÂä°', 'AIÂü∫Á°ÄÂª∫ËÆÆ']
})

// ÂÅ•Â∫∑Â∞èË¥¥Â£´Â∫ì
const healthTips = [
    'ÊØèÂ§©È£üÁî®2-3Áßç‰∏çÂêåÈ¢úËâ≤ÁöÑÊ∞¥ÊûúÔºåËÉΩÂ§üËé∑ÂæóÊõ¥ÂÖ®Èù¢ÁöÑËê•ÂÖªÁ¥†„ÄÇ',
    'È•≠ÂêéÂçäÂ∞èÊó∂È£üÁî®Ê∞¥ÊûúÊúâÂä©‰∫éÊ∂àÂåñÔºåÈÅøÂÖçÈ§êÂâçÂ§ßÈáèÈ£üÁî®„ÄÇ',
    'Â∫îÂ≠£Ê∞¥Êûú‰∏ç‰ªÖÊñ∞È≤úÁæéÂë≥ÔºåËê•ÂÖª‰ª∑ÂÄº‰πüÊõ¥È´òÔºå‰ª∑Ê†ºÊõ¥ÂÆûÊÉ†„ÄÇ',
    'Ê∞¥ÊûúÊúÄÂ•ΩÂú®‰∏äÂçàÊàñ‰∏ãÂçàÈ£üÁî®ÔºåÊôö‰∏äÈ£üÁî®ÂèØËÉΩÂΩ±ÂìçÊ∂àÂåñ„ÄÇ',
    'ÊúâÊú∫Ê∞¥ÊûúËôΩÁÑ∂‰ª∑Ê†ºËæÉÈ´òÔºå‰ΩÜÂÜúËçØÊÆãÁïôÊõ¥Â∞ëÔºåÊõ¥ÂÆâÂÖ®ÂÅ•Â∫∑„ÄÇ',
    'ÂÜ∑ÂÜªÊ∞¥Êûú‰πüÊòØ‰∏çÈîôÁöÑÈÄâÊã©ÔºåËê•ÂÖªÊàêÂàÜÂü∫Êú¨‰∏ç‰ºöÊµÅÂ§±„ÄÇ',
    'Ê¶®Ê±Å‰∏çÂ¶ÇÁõ¥Êé•È£üÁî®Ê∞¥ÊûúÔºåËÉΩ‰øùÁïôÊõ¥Â§öËÜ≥È£üÁ∫§Áª¥„ÄÇ',
    'Á≥ñÂ∞øÁóÖÊÇ£ËÄÖÂ∫îÈÄâÊã©‰ΩéÁ≥ñÊ∞¥ÊûúÔºåÂ¶ÇËãπÊûú„ÄÅÊüöÂ≠êÁ≠â„ÄÇ'
]

// ÊñπÊ≥ï
const showMessage = (message: string, color: string = 'success') => {
    snackbarText.value = message
    snackbarColor.value = color
    snackbar.value = true
}

const formatDate = (date: Date): string => {
    return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
    })
}

const getLifePropertiesArray = (fruit: Fruit): string[] => {
    if (!fruit?.lifeProperties) {
        return []
    }

    try {
        if (Array.isArray(fruit.lifeProperties)) {
            return fruit.lifeProperties
        }

        if (typeof fruit.lifeProperties === 'string') {
            if (!fruit.lifeProperties.trim()) {
                return []
            }
            const parsed = JSON.parse(fruit.lifeProperties)
            return Array.isArray(parsed) ? parsed : []
        }

        return []
    } catch (error) {
        console.error('Ëß£ÊûêÁîüÊ¥ªÂ±ûÊÄßÂ§±Ë¥•:', error)
        return []
    }
}

const loadDailyFruit = async () => {
    loading.value = true

    try {
        // Ê£ÄÊü•ÁºìÂ≠ò
        const cacheKey = 'dailyFruit'
        const cacheDateKey = 'dailyFruitDate'
        const cachedDate = localStorage.getItem(cacheDateKey)
        const today = getTodayDateString()

        // Â¶ÇÊûúÊòØÊñ∞ÁöÑ‰∏ÄÂ§©ÊàñÊ≤°ÊúâÁºìÂ≠òÔºåÈáçÊñ∞Ëé∑Âèñ
        if (!cachedDate || isNewDay(cachedDate)) {
            console.log('üçé Ëé∑Âèñ‰ªäÊó•Êé®ËçêÊ∞¥Êûú')

            const todayFruitName = getTodayFruitName()
            console.log(`üìÖ ‰ªäÊó•Êé®Ëçê: ${todayFruitName}`)

            const response = await getFruitByName(todayFruitName)

            if (response.code === 200 && response.data) {
                dailyFruit.value = response.data

                // ÁºìÂ≠òÊï∞ÊçÆ
                localStorage.setItem(cacheKey, JSON.stringify(response.data))
                localStorage.setItem(cacheDateKey, today)

                console.log('‚úÖ ‰ªäÊó•Êé®ËçêÊ∞¥ÊûúÂä†ËΩΩÊàêÂäü:', response.data.name)
                showMessage(`‰ªäÊó•‰∏∫ÊÇ®Êé®ËçêÔºö${response.data.name}`, 'success')
            } else {
                console.error('‚ùå Ëé∑Âèñ‰ªäÊó•Êé®ËçêÂ§±Ë¥•:', response)
                showMessage('Ëé∑Âèñ‰ªäÊó•Êé®ËçêÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error')
            }
        } else {
            // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ
            const cachedFruit = localStorage.getItem(cacheKey)
            if (cachedFruit) {
                dailyFruit.value = JSON.parse(cachedFruit)
                console.log('üì¶ ‰ΩøÁî®ÁºìÂ≠òÁöÑ‰ªäÊó•Êé®Ëçê:', dailyFruit.value?.name)
            }
        }
    } catch (error) {
        console.error('‚ùå Âä†ËΩΩ‰ªäÊó•Êé®ËçêÂ§±Ë¥•:', error)
        showMessage('Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'error')
    } finally {
        loading.value = false
    }
}

const exploreFruit = () => {
    console.log('üîç Êé¢Á¥¢Êõ¥Â§öÊ∞¥Êûú')
    router.push('/products')
}

const login = () => {
    console.log('üöÄ Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢')
    router.push('/login')
}

const register = () => {
    console.log('‚ú® Ë∑≥ËΩ¨Âà∞Ê≥®ÂÜåÈ°µÈù¢')
    router.push('/register')
}

// ÂÖàÂÆö‰πâÊâÄÊúâÁöÑÊñπÊ≥ïÂáΩÊï∞
const goToPointsCenter = () => {
    console.log('üèÜ Ë∑≥ËΩ¨Âà∞ÁßØÂàÜ‰∏≠ÂøÉ')
    router.push('/user/points')
}

const goToMarket = () => {
    console.log('üõí Ë∑≥ËΩ¨Âà∞Ê∞¥ÊûúÂïÜÂüé')
    router.push('/market')
}

const goToAI = () => {
    console.log('ü§ñ Ë∑≥ËΩ¨Âà∞AIÂä©Êâã')
    router.push('/ai-assistant')
}

const goToInventory = () => {
    console.log('üß∫ Ë∑≥ËΩ¨Âà∞ÊàëÁöÑÂ∫ìÂ≠ò')
    router.push('/user/inventory')
}

const goToAnalysis = () => {
    console.log('üìä Ë∑≥ËΩ¨Âà∞Ëê•ÂÖªÂàÜÊûê')
    router.push('/user/nutrition-analysis')
}

const goToProfile = () => {
    console.log('üë§ Ë∑≥ËΩ¨Âà∞‰∏™‰∫∫ËµÑÊñô')
    router.push('/user/profile')
}

const handleCheckIn = () => {
    if (todayCheckedIn.value) {
        showMessage('‰ªäÊó•Â∑≤ÁªèÁ≠æÂà∞Ëøá‰∫ÜÔºÅ', 'info')
        return
    }

    // Ê®°ÊãüÁ≠æÂà∞ÈÄªËæë
    todayCheckedIn.value = true
    consecutiveDays.value += 1

    // ËÆ°ÁÆóÁ≠æÂà∞Â•ñÂä±ÁßØÂàÜ
    const basePoints = 20 // Âü∫Á°ÄÁ≠æÂà∞ÁßØÂàÜ
    const bonusPoints = Math.min(consecutiveDays.value, 7) * 2 // ËøûÁª≠Â•ñÂä±ÔºåÊúÄÈ´ò14ÂàÜ
    const totalPoints = basePoints + bonusPoints

    userPoints.value += totalPoints

    console.log('‚úÖ Á≠æÂà∞ÊàêÂäüÔºåËé∑ÂæóÁßØÂàÜ:', totalPoints)
    showMessage(`Á≠æÂà∞ÊàêÂäüÔºÅËé∑Âæó ${totalPoints} ÁßØÂàÜÔºåËøûÁª≠Á≠æÂà∞ ${consecutiveDays.value} Â§©`, 'success')
}

const refreshHealthTip = () => {
    const currentTip = todayHealthTip.value
    let newTip = currentTip

    // Á°Æ‰øù‰∏ç‰ºöÊòæÁ§∫Áõ∏ÂêåÁöÑÊèêÁ§∫
    while (newTip === currentTip) {
        newTip = healthTips[Math.floor(Math.random() * healthTips.length)]
    }

    todayHealthTip.value = newTip
    showMessage('Â∑≤‰∏∫ÊÇ®Êõ¥Êç¢ÂÅ•Â∫∑Â∞èË¥¥Â£´', 'success')
}

// ÁÑ∂ÂêéÂÆö‰πâ‰ΩøÁî®Ëøô‰∫õÂáΩÊï∞ÁöÑÂìçÂ∫îÂºèÊï∞ÊçÆ
const quickActions = ref([
    { title: 'Ê∞¥ÊûúÂïÜÂüé', icon: 'üõí', handler: goToMarket },
    { title: 'AIÂä©Êâã', icon: 'ü§ñ', handler: goToAI },
    { title: 'ÊàëÁöÑÂ∫ìÂ≠ò', icon: 'üß∫', handler: goToInventory },
    { title: 'ÁßØÂàÜ‰∏≠ÂøÉ', icon: 'üí∞', handler: goToPointsCenter },
    { title: 'Ëê•ÂÖªÂàÜÊûê', icon: 'üìä', handler: goToAnalysis },
    { title: '‰∏™‰∫∫ËµÑÊñô', icon: 'üë§', handler: goToProfile }
])

// ‰øùÁïôÂπ∂Â¢ûÂº∫Ëé∑ÂèñÊ∞¥ÊûúemojiÊñπÊ≥ï
const getFruitEmoji = (fruitName: string): string => {
    const emojiMap: Record<string, string> = {
        // Â∏∏ËßÅÊ∞¥Êûú
        'ËãπÊûú': 'üçé', 'È¶ôËïâ': 'üçå', 'Ê©ôÂ≠ê': 'üçä', 'Ëë°ËêÑ': 'üçá', 'ËçâËéì': 'üçì',
        'Ë•øÁìú': 'üçâ', 'ÁåïÁå¥Ê°É': 'ü•ù', 'Ëè†Ëêù': 'üçç', 'ËäíÊûú': 'ü•≠', 'Ê®±Ê°É': 'üçí',
        'Ê°ÉÂ≠ê': 'üçë', 'Ê¢®': 'üçê', 'ËìùËéì': 'ü´ê', 'ÁÅ´ÈæôÊûú': 'üê≤', 'Ê¶¥Ëé≤': 'ü•¥',

        // ÁÉ≠Â∏¶Ê∞¥Êûú
        'Ê§∞Â≠ê': 'ü••', 'Êú®Áìú': 'üß°', 'Áï™Áü≥Ê¶¥': 'üçà', 'Á∫¢ÊØõ‰∏π': 'üî¥', 'Â±±Á´π': 'üü£',
        'Ëé≤Èõæ': 'üíß', 'Êù®Ê°É': '‚≠ê', 'ÈáäËø¶': 'ü§ç', 'ÁâõÊ≤πÊûú': 'ü•ë', 'ÁôæÈ¶ôÊûú': 'üíõ',
        'ÈæôÁúº': 'üëÅÔ∏è', 'ËçîÊûù': 'üî¥', '‰∫∫ÂèÇÊûú': 'üåü', 'Á•ûÁßòÊûú': '‚ùì', 'ÂòâÂÆùÊûú': 'üü£', 'ÈªÑÁöÆ': 'üü°',

        // ÊµÜÊûúÁ±ª
        'ÈªëËéì': '‚ö´', 'Ë¶ÜÁõÜÂ≠ê': 'üî¥', 'Ê°ëËëö': 'üü£', 'ÈÜãÊ†ó': 'üü¢', 'ÈπÖËéì': 'üü¢',
        'Ê≤ôÊ£ò': 'üü†', 'Êû∏Êùû': 'üî¥', 'ËîìË∂äËéì': 'üî¥', 'ÈªëÂä†‰ªë': '‚ö´', 'Á∫¢Âä†‰ªë': 'üî¥',

        // ÊüëÊ©òÁ±ª
        'ÊüöÂ≠ê': 'üü°', 'Êü†Ê™¨': 'üçã', 'ÈùíÊü†': 'üü¢', 'ÈáëÊ°î': 'üü†', 'Á†ÇÁ≥ñÊ©ò': 'üü†',
        'Ê≤ÉÊüë': 'üü†', 'Ë°ÄÊ©ô': 'üî¥', '‰ΩõÊâãÊüë': 'üü°', 'È¶ôÊ©ô': 'üü†', 'ÁîúÊ©ô': 'üü†',

        // Ê†∏ÊûúÁ±ª
        'Êùè': 'üü°', 'ÊùéÂ≠ê': 'üü£', 'Ê¢ÖÂ≠ê': 'üü¢', 'Ê≤πÊ°É': 'üçë', 'Ëü†Ê°É': 'üçë',
        'ÈªÑÊ°É': 'üü°', 'Ê∞¥ËúúÊ°É': 'üçë', 'Á¥´Êùé': 'üü£', 'ÈùíÊ¢Ö': 'üü¢', '‰πåÊ¢Ö': '‚ö´',

        // ÁìúÊûúÁ±ª
        'ÂìàÂØÜÁìú': 'üçà', 'È¶ôÁìú': 'üçà', 'ÁîúÁìú': 'üçà', 'ÁôΩÂÖ∞Áìú': 'ü§ç', '‰ºä‰∏ΩËééÁôΩÁìú': 'üëë',
        'Èáë‰∏ùÁìú': 'üü°', 'ÁæäËßíËúú': 'üêè', 'ÁΩëÁ∫πÁìú': 'üï∏Ô∏è', 'ÈªÑÊ≤≥Ëúú': 'üü°', 'ËÑÜÁìú': 'üíé',

        // ÂùöÊûúÁ±ª
        'Ê†∏Ê°É': 'ü•ú', 'Êùè‰ªÅ': 'ü•ú', 'Ê¶õÂ≠ê': 'ü•ú', 'ÂºÄÂøÉÊûú': 'ü•ú', 'ËÖ∞Êûú': 'ü•ú',
        'Â§èÂ®ÅÂ§∑Êûú': 'ü•ú', 'Á¢ßÊ†πÊûú': 'ü•ú', 'Â∑¥Êó¶Êú®': 'ü•ú', 'ÊùæÂ≠ê': 'ü•ú', 'ÊùøÊ†ó': 'üå∞',
        'Èì∂Êùè': 'üü°', 'ÁôΩÊûú': '‚ö™', 'Ëä±Áîü': 'ü•ú', 'ÁìúÂ≠ê': 'üåª',

        // ËøõÂè£Ê∞¥Êûú
        'ËΩ¶ÂéòÂ≠ê': 'üçí', 'Â•áÂºÇÊûú': 'ü•ù', 'ÊèêÂ≠ê': 'üçá', 'Êó†Ëä±Êûú': 'üü£', 'Ê©ÑÊ¶Ñ': 'ü´í',
        'Áü≥Ê¶¥': 'üî¥', 'ÊüøÂ≠ê': 'üü†', 'Êû£': 'üî¥', 'Â±±Ê•Ç': 'üî¥', 'ÈÖ∏Êû£': 'üü¢'
    }

    return emojiMap[fruitName] || 'üçé' // ÈªòËÆ§ËãπÊûúemoji
}

// ÁîüÂëΩÂë®Êúü
onMounted(async () => {
    // ÂàùÂßãÂåñËÆ§ËØÅÁä∂ÊÄÅ
    if (!authStore.token) {
        authStore.initializeAuth()
    }

    // Â¶ÇÊûúÁî®Êà∑Â∑≤ÁôªÂΩïÔºåÂä†ËΩΩ‰ªäÊó•Êé®Ëçê
    if (isLoggedIn.value) {
        // Âä†ËΩΩÁî®Êà∑ËØ¶ÁªÜ‰ø°ÊÅØÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
        if (!authStore.userProfileLoaded) {
            try {
                await authStore.loadUserProfile()
            } catch (error) {
                console.error('‚ùå Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error)
            }
        }

        // Âä†ËΩΩ‰ªäÊó•Êé®ËçêÊ∞¥Êûú
        await loadDailyFruit()

        console.log(`üçé Ê¨¢ËøéÂõûÊù•, ${username.value}! ‰ªäÊó•Êé®ËçêÂ∑≤‰∏∫ÊÇ®ÂáÜÂ§áÂ•ΩÔºÅ`)
    } else {
        console.log('üçé Ê∏∏ÂÆ¢‰Ω†Â•Ω, ÁôªÂΩïÂêéËé∑ÂèñÊØèÊó•Ê∞¥ÊûúÊé®ËçêÔºÅ')
    }
})
</script>

<style scoped>
.home-page {
    position: relative;
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

.home-content {
    margin-top: 64px;
}

/* ‰∏ªÂÜÖÂÆπÂå∫Âùó */
.main-content-section {
    padding: 40px 0;
    min-height: calc(100vh - 64px);
}

.today-recommendation-wrapper {
    height: 100%;
}

/* Âè≥‰æßÂäüËÉΩÈù¢Êùø */
.function-panel {
    position: sticky;
    top: 80px;
    height: fit-content;
}

/* Áî®Êà∑Áä∂ÊÄÅÂç°Áâá */
.user-status-card {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(139, 195, 74, 0.05) 100%);
    border-left: 4px solid #4CAF50;
}

.welcome-text {
    font-size: 1rem;
    font-weight: 600;
    color: #2E7D32;
}

.status-item {
    text-align: center;
    padding: 8px 4px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.status-item:hover {
    background: rgba(76, 175, 80, 0.1);
    transform: translateY(-2px);
}

.status-item.checked-in {
    background: rgba(76, 175, 80, 0.1);
}

.status-icon {
    font-size: 1.5rem;
    margin-bottom: 4px;
}

.status-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #2E7D32;
    margin-bottom: 2px;
}

.status-label {
    font-size: 0.7rem;
    color: #666;
}

/* Âø´Êç∑ÂäüËÉΩÂç°Áâá */
.quick-functions-card {
    background: rgba(255, 255, 255, 0.95);
}

.quick-action-item {
    text-align: center;
    padding: 12px 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(76, 175, 80, 0.05);
    margin-bottom: 8px;
}

.quick-action-item:hover {
    background: rgba(76, 175, 80, 0.15);
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.action-icon {
    font-size: 1.5rem;
    margin-bottom: 4px;
}

.action-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #333;
}

/* ÂÅ•Â∫∑Ë¥¥Â£´Âç°Áâá */
.health-tip-card {
    background: linear-gradient(135deg, rgba(33, 150, 243, 0.05) 0%, rgba(100, 181, 246, 0.05) 100%);
    border-left: 4px solid #2196F3;
}

/* Ë∞ÉÊï¥‰ªäÊó•Êé®ËçêÂç°Áâá */
.daily-fruit-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
    overflow: hidden;
}

.daily-fruit-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
}

.fruit-image-section {
    position: relative;
    overflow: hidden;
    height: 350px;
}

.fruit-emoji-display {
    height: 350px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    position: relative;
    overflow: hidden;
}

.emoji-container {
    text-align: center;
    padding: 20px;
    position: relative;
    z-index: 1;
}

.fruit-emoji {
    font-size: 4rem;
    margin-bottom: 16px;
    animation: fruitFloat 3s ease-in-out infinite;
    filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.1));
    display: block;
}

.fruit-name-text {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2E7D32;
    margin-bottom: 12px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.decoration-dots {
    display: flex;
    justify-content: center;
    gap: 16px;
    font-size: 1.2rem;
}

.decoration-dots span {
    animation: sparkle 2s ease-in-out infinite;
    animation-delay: calc(var(--i) * 0.5s);
}

.decoration-dots span:nth-child(1) {
    --i: 0;
}

.decoration-dots span:nth-child(2) {
    --i: 1;
}

.decoration-dots span:nth-child(3) {
    --i: 2;
}

.fruit-emoji-display::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background:
        radial-gradient(circle at 20% 80%, rgba(76, 175, 80, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(139, 195, 74, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 193, 7, 0.05) 0%, transparent 50%);
    animation: backgroundFloat 8s ease-in-out infinite;
    z-index: 0;
}

.date-badge {
    position: absolute;
    top: 16px;
    left: 16px;
    z-index: 1;
}

.fruit-name {
    color: #4CAF50;
}

.info-cards-row .v-card {
    height: 60px;
}

.info-cards-row .v-card-text {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

/* Ê∞¥ÊûúÊµÆÂä®Âä®Áîª */
@keyframes fruitFloat {

    0%,
    100% {
        transform: translateY(0px) rotate(0deg) scale(1);
    }

    25% {
        transform: translateY(-8px) rotate(1deg) scale(1.02);
    }

    50% {
        transform: translateY(-12px) rotate(0deg) scale(1.05);
    }

    75% {
        transform: translateY(-6px) rotate(-1deg) scale(1.02);
    }
}

/* Ë£ÖÈ•∞Èó™ÁÉÅÂä®Áîª */
@keyframes sparkle {

    0%,
    100% {
        opacity: 0.6;
        transform: scale(1) rotate(0deg);
    }

    50% {
        opacity: 1;
        transform: scale(1.2) rotate(180deg);
    }
}

/* ËÉåÊôØÊµÆÂä®Âä®Áîª */
@keyframes backgroundFloat {

    0%,
    100% {
        transform: rotate(0deg);
    }

    50% {
        transform: rotate(180deg);
    }
}

/* ÁßªÂä®Á´ØÈÄÇÈÖç */
@media (max-width: 1280px) {
    .function-panel {
        position: static;
        margin-top: 20px;
    }

    .main-content-section {
        padding: 20px 0;
    }
}

@media (max-width: 960px) {

    .fruit-image-section,
    .fruit-emoji-display {
        height: 250px;
    }

    .fruit-emoji {
        font-size: 3rem;
        margin-bottom: 12px;
    }

    .fruit-name-text {
        font-size: 1.3rem;
        margin-bottom: 8px;
    }

    .info-cards-row .v-card {
        height: 50px;
    }

    .action-title {
        font-size: 0.7rem;
    }
}

@media (max-width: 600px) {
    .home-content {
        margin-top: 56px;
    }

    .main-content-section {
        padding: 16px 0;
    }

    .fruit-image-section,
    .fruit-emoji-display {
        height: 200px;
    }

    .fruit-emoji {
        font-size: 2.5rem;
        margin-bottom: 8px;
    }

    .fruit-name-text {
        font-size: 1.2rem;
        margin-bottom: 6px;
    }

    .decoration-dots {
        gap: 12px;
        font-size: 1rem;
    }

    .status-icon {
        font-size: 1.2rem;
    }

    .status-value {
        font-size: 1rem;
    }

    .action-icon {
        font-size: 1.2rem;
    }

    .action-title {
        font-size: 0.65rem;
    }
}
</style>
